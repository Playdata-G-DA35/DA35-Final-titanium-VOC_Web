{% extends 'navi.html' %}

{% block title %}리뷰량 분석{% endblock %}

{% block content %}
{% load static %}
<script src="https://d3js.org/d3.v7.min.js"></script>

<link rel="stylesheet" href="{% static 'basic_html.css' %}">

<!-- 상단의 기간 선택 및 차트 필터 폼 -->
<h1 class="font-bold bg-gray-300 p-2 text-left text-2xl box2">리뷰량 분석</h1>
<section class="card bg-white shadow-md rounded-md p-2 mb-4 w-80">
    <form method="post" id="periodForm">
        <div class="header-container">
            <div class="form-container">
                {% csrf_token %}
                <div class="form-group">
                    <label for="start_period" class= "text-xl">시작 기간:</label>
                    <input type="month" id="start_period" name="start_period" value="2024-01" required>
                </div>
                
                <div class="form-group">
                    <label for="end_period" class= "text-xl">종료 기간:</label>
                    <input type="month" id="end_period" name="end_period" value="2024-08" required>
                </div>
                
                <div class="form-group">
                    <label for="category" class= "text-xl">카테고리:</label>
                    <select id="category" name="category" required>
                        <option value="상의">상의</option>
                        <option value="바지">바지</option>
                        <option value="아우터">아우터</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <button type="submit" onclick="fetchWordclouds() ,fetchWordFrequency();" class="active">적용</button>
                </div>
            </div>
        </div>
    </form>
</section>
<!-- 날짜타입 선택 부분을 새로운 위치에 추가 -->
<section class="card bg-white shadow-md rounded-md p-4 mb-5">
    <h2>리뷰량 비교:</h2>
    <div class="chart-container">
        <div class="chart-type-selector">
            <label for="chart_type">날짜타입:</label>
            <select id="chart_type" name="chart_type" required>
                <option value="monthly">월별</option>
                <option value="weekly">주별</option>
                <option value="daily">일별</option>
            </select>
        </div>
    </div>
    <div id="chart"></div>
</section>

<section class="card bg-white shadow-md rounded-md p-4 mb-5">
    <!-- 카테고리 별 단어 빈도 분석 -->
    <div class="block">
        <h2>카테고리 별 단어 빈도 분석</h2>
        <div class="chart-type-buttons" style="text-align: right;">
            <button onclick="fetchWordclouds()" class="bg-gray-200">월별</button>
        </div>
        <div class="wordcloud-container">
            <div class="wordcloud-block">
                <h3 id="musinsaWordcloudTitle">무신사 스탠다드</h3>
                <div class="navigation-button left" onclick="navigateWordcloud('musinsa', -1)">&#8249;</div>
                <div id="musinsaWordcloud">
                    <img id="musinsaWordcloudImage" alt="Musinsa Wordcloud" />
                </div>
                <div class="navigation-button right" onclick="navigateWordcloud('musinsa', 1)">&#8250;</div>
            </div>
            <div class="wordcloud-block">
                <h3 id="spaWordcloudTitle">SPA</h3>
                <div class="navigation-button left" onclick="navigateWordcloud('spa', -1)">&#8249;</div>
                <div id="spaWordcloud">
                    <img id="spaWordcloudImage" alt="SPA Wordcloud" />
                </div>
                <div class="navigation-button right" onclick="navigateWordcloud('spa', 1)">&#8250;</div>
            </div>
        </div>
    </div>
</section>

<section class="card bg-white shadow-md rounded-md p-4 mb-5">
    <div class="block price-range-container">
        <div id="wordFrequencyTables" >
        </div>
        <div class="price-range-buttons">
            <span class="price-range-label">가격대:</span>
            <button onclick="fetchWordFrequency();showPriceRange('1~2만원대')">1~2만원대</button>
            <button onclick=" showPriceRange('3~4만원대')">3~4만원대</button>
            <button onclick=" showPriceRange('5만원대 이상')">5만원대 이상</button>
        </div>
    </div>
</section>
<!-- 성별 비율 도넛 차트 -->
<section class="card bg-white shadow-md rounded-md p-4 mb-5">
    <h2 class= text-3xl>브랜드별 성별 비율</h2>
    <div class="charts-container">
        <div id="musinsaPieChart"></div>
        <div id="spaPieChart"></div>
    </div>
</section>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('periodForm').dispatchEvent(new Event('submit', { 'bubbles': true }));
    });

    document.getElementById('periodForm').onsubmit = function(event) {
        event.preventDefault();

        const start_period = document.getElementById('start_period').value;
        const end_period = document.getElementById('end_period').value;
        const category = document.getElementById('category').value;
        const chart_type = document.getElementById('chart_type').value;

        const data = {
            start_period: start_period,
            end_period: end_period,
            category: [category],
            chart_type: chart_type
        };

        fetch('/review/get-filtered-reviews/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken') // CSRF 토큰 추가
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            renderLineChart(result);
            fetchGenderDistribution(); // 성별 분포 데이터 가져오기
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('chart').innerHTML = 'Error: ' + error;
        });
    };

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function renderLineChart(data) {
        // Clear previous chart
        d3.select("#chart").selectAll("*").remove();

        const margin = {top: 20, right: 20, bottom: 30, left: 50},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        const parseTime = d3.timeParse("%Y-%m-%d");
        const formatTime = d3.timeFormat("%m월 %d일"); // 한국어 형식으로 날짜 포맷

        const x = d3.scaleTime().range([0, width]);
        const y = d3.scaleLinear().range([height, 0]);

        const line = d3.line()
            .x(d => x(d.date))
            .y(d => y(d.review_count));

        const svg = d3.select("#chart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
        .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        const color = d3.scaleOrdinal(d3.schemeCategory10);

        const brands = Array.from(new Set(data.map(d => d.brand_group)));

        color.domain(brands);

        data.forEach(d => {
            d.date = parseTime(d.period);
            d.review_count = +d.review_count;
        });

        // 그룹핑
        const dataNest = d3.group(data, d => d.brand_group);

        x.domain(d3.extent(data, d => d.date));
        y.domain([0, d3.max(data, d => d.review_count)]);

        svg.selectAll(".line")
            .data(Array.from(dataNest.entries()))
        .enter().append("path")
            .attr("class", "line")
            .attr("d", d => line(d[1]))
            .style("stroke", d => color(d[0]))
            .style("fill", "none")
            .style("stroke-width", "2px");

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x)
                .tickFormat(d => formatTime(d)) // 한국어로 날짜 포맷
            );

        svg.append("g")
            .attr("class", "y axis")
            .call(d3.axisLeft(y));

        const legend = svg.selectAll(".legend")
            .data(brands)
        .enter().append("g")
            .attr("class", "legend")
            .attr("transform", (d, i) => "translate(0," + (i * 20) + ")");

        legend.append("rect")
            .attr("x", width - 18)
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", d => color(d));

        legend.append("text")
            .attr("x", width - 24)
            .attr("y", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "end")
            .text(d => d);
    }

    function renderPieChart(data, containerId, colorScheme, title) {
    // Clear previous pie chart
    d3.select(containerId).selectAll("*").remove();

    const margin = {top: 20, right: 20, bottom: 30, left: 20},
        width = 500 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom,
        radius = Math.min(width, height) / 2;

    const svg = d3.select(containerId).append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + (width / 2 + margin.left) + "," + (height / 2 + margin.top) + ")");

    const color = colorScheme; // 색상 정의

    const pie = d3.pie()
        .sort(null)
        .value(d => d.value);

    const arc = d3.arc()
        .outerRadius(radius - 10)
        .innerRadius(radius - 120); // 도넛 모양으로 설정

    const labelArc = d3.arc()
        .outerRadius(radius - 40)
        .innerRadius(radius - 40);

    const pieData = [
        {label: '여성', value: data.Female_count},
        {label: '남성', value: data.Male_count}
    ];

    const arcs = svg.selectAll(".arc")
        .data(pie(pieData))
    .enter().append("g")
        .attr("class", "arc");

    arcs.append("path")
        .attr("d", arc)
        .style("fill", d => color(d.data.label))
        .style("stroke", "#fff") // Add stroke to ensure visibility
        .style("stroke-width", "2px");

    arcs.append("text")
        .attr("transform", d => "translate(" + labelArc.centroid(d) + ")")
        .attr("dy", ".35em")
        .style("text-anchor", "middle")
        .text(d => `${Math.round(d.data.value / d3.sum(pieData, d => d.value) * 100)}%`);

    // Add legend
    const legend = d3.select(containerId).append("div")
        .attr("class", "legend");

    pieData.forEach((d) => {
        legend.append("div")
            .attr("class", "legend-item")
            .html(`
                <div class="legend-color-box" style="background-color: ${color(d.label)}"></div>
                ${d.label}
            `);
    });

    // Add title
    d3.select(containerId).append("div")
        .attr("class", "chart-title")
        .style("text-align", "center")
        .style("font-size", "18px")
        .style("font-weight", "bold")
        .text(title);
}


function fetchGenderDistribution() {
    const start_period = document.getElementById('start_period').value;
    const end_period = document.getElementById('end_period').value;
    const category = document.getElementById('category').value;

    const data = {
        start_period: start_period,
        end_period: end_period,
        category: [category]
    };

    fetch('/review/get-gender-distribution/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken') // CSRF 토큰 추가
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        const musinsaData = result.find(d => d.brand_group === '무신사 스탠다드') || {};
        const spaData = result.find(d => d.brand_group === 'SPA') || {};
        
        const musinsaColorScheme = d3.scaleOrdinal(["#aec7e8","#1f77b4"]); // 무신사 파란색 계열
        const spaColorScheme = d3.scaleOrdinal(["#ffbb78","#ff7f0e"]); // SPA 주황색 계열
        
        renderPieChart(musinsaData, "#musinsaPieChart", musinsaColorScheme, "무신사 스탠다드 성별 분포");
        renderPieChart(spaData, "#spaPieChart", spaColorScheme, "SPA 성별 분포");
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('musinsaPieChart').innerHTML = 'Error: ' + error;
        document.getElementById('spaPieChart').innerHTML = 'Error: ' + error;
    });
}
let wordcloudsData = {
        musinsa: [],
        spa: []
    };
    let currentWordcloudIndex = {
        musinsa: 0,
        spa: 0
    };

    function fetchData() {
        updateReviewCounts('daily');  // 기본값으로 일별 데이터 표시
        fetchWordclouds();
        fetchWordFrequency();
    }

    function updateReviewCounts(chartType) {
        const start_period = document.getElementById('start_period').value;
        const end_period = document.getElementById('end_period').value;
        const category = document.getElementById('category').value;

        const data = { start_period, end_period, category, chart_type: chartType };

        fetch('/review/get-filtered-reviews/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            document.getElementById('reviewCountsResult').textContent = JSON.stringify(result, null, 2);
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('reviewCountsResult').textContent = 'Error: ' + error;
        });
    }


    function fetchWordclouds() {
        const start_period = document.getElementById('start_period').value;
        const end_period = document.getElementById('end_period').value;
        const category = document.getElementById('category').value;

        const brands = ['무신사 스탠다드', 'SPA'];

        brands.forEach(brand => {
            fetch('/review/get-review-wordcloud/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ start_period, end_period, category, brand })
            })
            .then(response => response.json())
            .then(result => {
                if (brand === '무신사 스탠다드') {
                    wordcloudsData.musinsa = result.images;
                    currentWordcloudIndex.musinsa = 0;
                    updateWordcloud('musinsa');
                } else if (brand === 'SPA') {
                    wordcloudsData.spa = result.images;
                    currentWordcloudIndex.spa = 0;
                    updateWordcloud('spa');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    }

    function updateWordcloud(brand) {
        const brandId = brand === 'musinsa' ? 'musinsa' : 'spa';
        const wordcloudData = wordcloudsData[brandId];
        const currentIndex = currentWordcloudIndex[brandId];

        if (wordcloudData && wordcloudData.length > 0) {
            const imgElement = document.getElementById(brandId + 'WordcloudImage');
            const titleElement = document.getElementById(brandId + 'WordcloudTitle');
            const currentData = wordcloudData[currentIndex];

            imgElement.src = 'data:image/png;base64,' + currentData.image;
            titleElement.textContent = currentData.filename;
        }
    }

    function navigateWordcloud(brand, direction) {
        const brandId = brand === 'musinsa' ? 'musinsa' : 'spa';
        const wordcloudData = wordcloudsData[brandId];

        if (wordcloudData && wordcloudData.length > 0) {
            currentWordcloudIndex[brandId] += direction;

            if (currentWordcloudIndex[brandId] < 0) {
                currentWordcloudIndex[brandId] = wordcloudData.length - 1;
            } else if (currentWordcloudIndex[brandId] >= wordcloudData.length) {
                currentWordcloudIndex[brandId] = 0;
            }

            updateWordcloud(brandId);
        }
    }




    function createTable(priceRange, brand, data) {
        const table = document.createElement('table');
        table.border = "1";

        const thead = document.createElement('thead');
        thead.innerHTML = `
            <tr>
                <th colspan="3">${brand} - ${priceRange}</th>
            </tr>
            <tr>
                <th>NO.</th>
                <th>단어명</th>
                <th>빈도수</th>
            </tr>
        `;

        const tbody = document.createElement('tbody');

        if (data.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td colspan="3">No data available</td>
            `;
            tbody.appendChild(row);
        } else {
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.단어명}</td>
                    <td>${item.빈도수}</td>
                `;
                tbody.appendChild(row);
            });
        }

        table.appendChild(thead);
        table.appendChild(tbody);

        return table;
    }


    function fetchWordFrequency() {
    const start_period = document.getElementById('start_period').value;
    const end_period = document.getElementById('end_period').value;
    const category = document.getElementById('category').value;

    const data = { start_period, end_period, category };

    fetch('/review/get-word-frequency-by-price-range/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        console.log('Fetch successful', result); // Debugging

        const tablesContainer = document.getElementById('wordFrequencyTables');
        tablesContainer.innerHTML = '';

        Object.keys(result).forEach(priceRange => {
            const rangeData = result[priceRange];

            const musinsaTable = createTable(priceRange, '무신사 스탠다드', rangeData.musinsa);
            const spaTable = createTable(priceRange, 'SPA', rangeData.spa);

            const rangeContainer = document.createElement('div');
            rangeContainer.dataset.priceRange = priceRange;
            rangeContainer.style.display = 'none'; // Start hidden
            rangeContainer.style.justifyContent = 'space-between';
            rangeContainer.style.marginBottom = '20px';
            rangeContainer.appendChild(musinsaTable);
            rangeContainer.appendChild(spaTable);

            tablesContainer.appendChild(rangeContainer);
        });

        // Show the first price range by default
        if (Object.keys(result).length > 0) {
            showPriceRange(Object.keys(result)[0]);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}


function showPriceRange(range) {
    console.log('Showing range:', range);
    const tables = document.querySelectorAll('#wordFrequencyTables > div');
    tables.forEach(table => {
        if (table.dataset.priceRange === range) {
            table.style.display = 'flex';
        } else {
            table.style.display = 'none';
        }
    });
}
window.onload = function() {
        fetchWordclouds(); // 페이지가 로드될 때 '월별' 버튼 클릭
        fetchWordFrequency();
    };


</script>
{% endblock %}
